<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-1B3TL3YJ0J"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-1B3TL3YJ0J");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MegaSplit - Ø£Ø¯Ø§Ø© ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ± | Ali Ahmed</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/fonts.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link rel="stylesheet" href="../assets/css/design-enhancements.css" />
    <link rel="stylesheet" href="../assets/css/animations.css" />
    <link rel="stylesheet" href="../assets/css/svg-icons.css" />
    <link
      rel="icon"
      href="../assets/images/logo ico.svg"
      type="image/svg+xml"
    />

    <!-- Scripts for 3D Background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="../assets/js/three-bg.js" defer></script>
    <script src="../assets/js/main.js" defer></script>
    <script src="../assets/js/svg-icons.js" defer></script>

    <style>
      :root {
        --split-primary: #5e3bee;
        --split-primary-dark: #4a2fbe;
        --split-primary-light: #7d56f9;
        --split-success: #10b981;
        --split-error: #ef4444;
        --split-warning: #f59e0b;
        --split-blue: #3b82f6;
      }

      * {
        box-sizing: border-box;
      }

      .tool-page-wrapper {
        padding: 130px 0 80px;
        min-height: 80vh;
        position: relative;
        z-index: 1;
      }

      .megasplit-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .tool-hero {
        text-align: center;
        margin-bottom: 40px;
      }

      .tool-hero h1 {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 16px;
      }

      .tool-hero p {
        color: var(--text-color-light);
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto;
      }

      .app-container {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--box-shadow);
        padding: 40px;
        border: 1px solid var(--border-color);
      }

      /* Upload Section */
      .upload-section {
        margin-bottom: 30px;
      }

      .upload-zone {
        border: 3px dashed var(--primary-color);
        border-radius: var(--border-radius-lg);
        padding: 60px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, rgba(94, 59, 238, 0.05) 0%, rgba(125, 86, 249, 0.05) 100%);
        position: relative;
        overflow: hidden;
      }

      .upload-zone::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -30%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(94, 59, 238, 0.1) 0%, transparent 60%);
        animation: pulse 4s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 0.8; }
      }

      .upload-zone:hover,
      .upload-zone.drag-over {
        border-color: var(--primary-dark);
        background: linear-gradient(135deg, rgba(94, 59, 238, 0.1) 0%, rgba(125, 86, 249, 0.1) 100%);
        transform: scale(1.02);
      }

      .upload-zone i {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 20px;
        display: block;
        position: relative;
        z-index: 1;
      }

      .upload-zone h3 {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .upload-zone p {
        color: var(--text-color-light);
        font-size: 1rem;
        position: relative;
        z-index: 1;
      }

      .format-badges {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
        position: relative;
        z-index: 1;
      }

      .format-badge {
        padding: 8px 16px;
        background: white;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--primary-color);
        box-shadow: 0 2px 10px rgba(94, 59, 238, 0.2);
      }

      [data-theme="dark"] .format-badge {
        background: var(--input-bg);
        color: var(--primary-light);
      }

      .upload-zone input[type="file"] {
        display: none;
      }

      /* Editor Section */
      .editor-section {
        display: none;
        margin-bottom: 30px;
      }

      .editor-section.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
      }

      .editor-header h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .editor-header h3 i {
        color: var(--primary-color);
      }

      .editor-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(94, 59, 238, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(94, 59, 238, 0.4);
      }

      .btn-secondary {
        background: var(--bg-color-alt);
        color: var(--text-color);
        border: 2px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-color);
      }

      .btn-success {
        background: var(--split-success);
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: var(--split-error);
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      /* Canvas Container */
      .canvas-container {
        position: relative;
        max-height: 600px;
        overflow-y: auto;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--input-bg);
        padding: 20px;
        margin-bottom: 25px;
      }

      .canvas-wrapper {
        position: relative;
        display: inline-block;
        max-width: 100%;
      }

      #imageCanvas {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .cut-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--split-error);
        cursor: move;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
      }

      .cut-line::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 20px;
        background: var(--split-error);
        border-radius: 10px;
      }

      .cut-line::after {
        content: 'â‹®â‹®';
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
        letter-spacing: -2px;
      }

      .cut-line-label {
        position: absolute;
        right: 10px;
        top: -25px;
        background: var(--split-error);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        white-space: nowrap;
      }

      .cut-line-remove {
        position: absolute;
        left: 10px;
        top: -12px;
        width: 24px;
        height: 24px;
        background: white;
        border: 2px solid var(--split-error);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--split-error);
        transition: all 0.2s ease;
      }

      .cut-line-remove:hover {
        background: var(--split-error);
        color: white;
        transform: scale(1.1);
      }

      /* Controls */
      .controls-panel {
        background: var(--bg-color-alt);
        border-radius: var(--border-radius);
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .control-item label {
        display: block;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-item label i {
        color: var(--primary-color);
      }

      .control-item select,
      .control-item input[type="number"] {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        background: var(--card-bg);
        color: var(--text-color);
        font-family: inherit;
        transition: border-color 0.2s ease;
      }

      .control-item select:focus,
      .control-item input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .info-banner {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-right: 4px solid var(--split-warning);
        border-radius: var(--border-radius);
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        color: #92400e;
      }

      [data-theme="dark"] .info-banner {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
        color: #fbbf24;
      }

      .info-banner i {
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .success-banner {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-right: 4px solid var(--split-success);
        color: #065f46;
      }

      [data-theme="dark"] .success-banner {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
        color: #6ee7b7;
      }

      /* Segments Preview */
      .segments-section {
        display: none;
      }

      .segments-section.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }

      .segments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .segments-header h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .segments-header h3 i {
        color: var(--split-success);
      }

      .segments-stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .stat-badge {
        padding: 8px 16px;
        background: rgba(94, 59, 238, 0.1);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .segments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .segment-card {
        background: var(--bg-color-alt);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 15px;
        transition: all 0.3s ease;
      }

      .segment-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 8px 25px rgba(94, 59, 238, 0.15);
        transform: translateY(-5px);
      }

      .segment-preview {
        width: 100%;
        height: 150px;
        object-fit: contain;
        border-radius: var(--border-radius);
        background: var(--card-bg);
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
      }

      .segment-info {
        margin-bottom: 12px;
      }

      .segment-name {
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .segment-name i {
        color: var(--primary-color);
        font-size: 0.8rem;
      }

      .segment-meta {
        display: flex;
        gap: 12px;
        font-size: 0.8rem;
        color: var(--text-color-light);
        flex-wrap: wrap;
      }

      .segment-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .segment-actions {
        display: flex;
        gap: 8px;
      }

      .segment-actions .btn {
        flex: 1;
        justify-content: center;
        font-size: 0.8rem;
        padding: 8px 12px;
      }

      /* Progress Overlay */
      .progress-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .progress-overlay.active {
        display: flex;
      }

      .progress-content {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 40px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .progress-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .progress-content h3 {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 10px;
      }

      .progress-content p {
        color: var(--text-color-light);
        font-size: 0.95rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .tool-hero h1 {
          font-size: 1.8rem;
        }

        .tool-hero p {
          font-size: 1rem;
        }

        .app-container {
          padding: 25px;
        }

        .upload-zone {
          padding: 40px 20px;
        }

        .upload-zone i {
          font-size: 3rem;
        }

        .editor-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .editor-actions {
          width: 100%;
        }

        .editor-actions .btn {
          flex: 1;
        }

        .controls-grid {
          grid-template-columns: 1fr;
        }

        .segments-grid {
          grid-template-columns: 1fr;
        }

        .segments-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body class="theme-aware">
    <div class="grain-overlay"></div>
    <div id="three-canvas-container"></div>
    <div class="floating-background">
      <div class="floating-icon" style="left: 10%; animation-duration: 8s; animation-delay: 0s">ğŸš€</div>
      <div class="floating-icon" style="left: 25%; animation-duration: 10s; animation-delay: 2s">â­</div>
      <div class="floating-icon" style="left: 40%; animation-duration: 12s; animation-delay: 4s">ğŸ”¥</div>
      <div class="floating-icon" style="left: 55%; animation-duration: 9s; animation-delay: 1s">ğŸ’</div>
      <div class="floating-icon" style="left: 70%; animation-duration: 11s; animation-delay: 3s">ğŸ¯</div>
      <div class="floating-icon" style="left: 85%; animation-duration: 13s; animation-delay: 5s">âš¡</div>
    </div>

    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <a href="../index.html">
              <img src="../assets/images/logo.svg" alt="Ali Ahmed" />
            </a>
          </div>
          <nav class="nav">
            <ul class="nav-links">
              <li><a href="../index.html#home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li><a href="../index.html#about">Ù…Ù† Ù†Ø­Ù†</a></li>
              <li><a href="../index.html#services">Ø®Ø¯Ù…Ø§ØªÙ†Ø§</a></li>
              <li><a href="../works.html">Ø£Ø¹Ù…Ø§Ù„Ù†Ø§</a></li>
              <li><a href="../index.html#salla-discounts">Ø£ÙƒÙˆØ§Ø¯ Ø®ØµÙ… Ø³Ù„Ø©</a></li>
              <li><a href="index.html" class="active">Ø£Ø¯ÙˆØ§ØªÙ†Ø§</a></li>
              <li><a href="../index.html#contact">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
              <li><a href="../index.html#payment">Ø§Ù„Ø¯ÙØ¹</a></li>
            </ul>
          </nav>
          <div class="header-actions">
            <div class="theme-toggle" onclick="toggleTheme()">
              <svg class="svg-icon" viewBox="0 0 512 512">
                <use href="../assets/images/icons.svg#icon-moon"></use>
              </svg>
            </div>
            <div class="mobile-toggle">
              <svg class="svg-icon" viewBox="0 0 448 512">
                <use href="../assets/images/icons.svg#icon-bars"></use>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="tool-page-wrapper">
      <div class="container">
        <div class="megasplit-container">
          <div class="tool-hero">
            <h1><i class="fas fa-cut"></i> MegaSplit - Ø£Ø¯Ø§Ø© ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ±</h1>
            <p>
              Ù‚Ù… Ø¨ØªÙ‚Ø³ÙŠÙ… ØµÙˆØ±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙˆØ§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¥Ù„Ù‰ Ø¹Ø¯Ø© Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ¨Ø¯ÙˆÙ† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©.
              Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§ØªØŒ ÙˆØ§Ù„ØªØµØ§Ù…ÙŠÙ… Ø§Ù„Ø·ÙˆÙŠÙ„Ø©!
            </p>
          </div>

          <div class="app-container">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
              <div class="upload-zone" id="uploadZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±ØªÙƒ Ù‡Ù†Ø§</h3>
                <p>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØµÙØ­ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</p>
                <div class="format-badges">
                  <span class="format-badge">JPG</span>
                  <span class="format-badge">PNG</span>
                  <span class="format-badge">WebP</span>
                  <span class="format-badge">GIF</span>
                </div>
                <p style="font-size: 0.85rem; margin-top: 16px; color: var(--text-color-muted);">
                  Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 20MB
                </p>
                <input type="file" id="fileInput" accept="image/*" />
              </div>
            </div>

            <!-- Editor Section -->
            <div class="editor-section" id="editorSection">
              <div class="editor-header">
                <h3><i class="fas fa-edit"></i> ØªØ­Ø±ÙŠØ± ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø©</h3>
                <div class="editor-actions">
                  <button class="btn btn-secondary btn-sm" onclick="resetApp()">
                    <i class="fas fa-undo"></i> ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                  </button>
                </div>
              </div>

              <div class="info-banner">
                <i class="fas fa-info-circle"></i>
                <span>Ø§Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ù‚Ø·Ø¹. ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø·ÙˆØ· Ù„ØªØºÙŠÙŠØ± Ù…ÙˆØ¶Ø¹Ù‡Ø§ Ø£Ùˆ Ø­Ø°ÙÙ‡Ø§.</span>
              </div>

              <!-- Controls -->
              <div class="controls-panel">
                <div class="controls-grid">
                  <div class="control-item">
                    <label><i class="fas fa-image"></i> ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±</label>
                    <select id="outputFormat">
                      <option value="image/png">PNG (Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©)</option>
                      <option value="image/jpeg">JPEG (Ø­Ø¬Ù… Ø£ØµØºØ±)</option>
                      <option value="image/webp">WebP (Ù…ØªÙˆØ§Ø²Ù†)</option>
                    </select>
                  </div>
                  <div class="control-item">
                    <label><i class="fas fa-sliders-h"></i> Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© (1-100)</label>
                    <input type="number" id="qualityInput" min="1" max="100" value="95" />
                  </div>
                  <div class="control-item">
                    <label><i class="fas fa-ruler-vertical"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…ØªØ³Ø§ÙˆÙŠØ©</label>
                    <input type="number" id="segmentsCount" min="2" max="20" value="2" />
                  </div>
                  <div class="control-item" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="addEqualSegments()">
                      <i class="fas fa-equals"></i> ØªÙ‚Ø³ÙŠÙ… Ù…ØªØ³Ø§ÙˆÙ
                    </button>
                  </div>
                </div>
              </div>

              <!-- Canvas -->
              <div class="canvas-container">
                <div class="canvas-wrapper" id="canvasWrapper">
                  <canvas id="imageCanvas"></canvas>
                  <div id="cutLinesContainer"></div>
                </div>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="processImage()">
                  <i class="fas fa-cut"></i> Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø©
                </button>
                <button class="btn btn-secondary" onclick="clearAllLines()">
                  <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ·
                </button>
              </div>
            </div>

            <!-- Segments Section -->
            <div class="segments-section" id="segmentsSection">
              <div class="success-banner">
                <i class="fas fa-check-circle"></i>
                <span>ØªÙ… ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¬Ù…ÙŠØ¹Ø§Ù‹ ÙÙŠ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·.</span>
              </div>

              <div class="segments-header">
                <h3><i class="fas fa-images"></i> Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø³Ù…Ø©</h3>
                <div class="segments-stats">
                  <span class="stat-badge">
                    <i class="fas fa-layer-group"></i>
                    <span id="segmentsTotal">0</span> Ø¬Ø²Ø¡
                  </span>
                </div>
              </div>

              <div class="segments-grid" id="segmentsGrid"></div>

              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="downloadAll()">
                  <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„ (ZIP)
                </button>
                <button class="btn btn-secondary" onclick="resetApp()">
                  <i class="fas fa-redo"></i> Ø¨Ø¯Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progressOverlay">
      <div class="progress-content">
        <div class="progress-spinner"></div>
        <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‚Ø³ÙŠÙ… ØµÙˆØ±ØªÙƒ</p>
      </div>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± -->
    <footer class="footer" id="footer_aboutus">
      <div class="container">
        <div class="footer-content">
          <div class="footer-about">
            <div class="footer-logo">
              <img src="../assets/images/logo.svg" alt="Ali Ahmed" />
            </div>
            <p class="about-text">
              Ù…ØµÙ…Ù… Ù…ØªØ®ØµØµ ÙÙŠ ØªØ·ÙˆÙŠØ± ÙˆØªØµÙ…ÙŠÙ… Ù…ØªØ§Ø¬Ø± Ù…Ù†ØµØ© Ø²Ø¯ ÙˆØ³Ù„Ø©ØŒ Ø£Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø§Øª ØªØ®ØµÙŠØµ CSS Ù„Ø¬Ø¹Ù„ Ù…ØªØ¬Ø±Ùƒ ÙØ±ÙŠØ¯Ø§Ù‹ ÙˆÙ…Ù…ÙŠØ². Ø®Ø¨Ø±Ø© ÙˆØ§Ø³Ø¹Ø© ÙÙŠ ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.
            </p>
            <div class="footer-certificate">
              <a href="https://www.behance.net/3lwaaa1" target="_blank">
                <img src="../assets/images/logo ico.svg" alt="Ali Ahmed" />
                <span>Ali Ahmed | Ù…ØµÙ…Ù… Ù…Ù†ØµØ© Ø²Ø¯ ÙˆØ³Ù„Ø©</span>
              </a>
            </div>
            <p class="footer-cr">Custom Css Salla zid</p>
          </div>

          <div class="footer-links">
            <h3>Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
            <ul>
              <li><a href="../index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li><a href="index.html">Ø£Ø¯ÙˆØ§ØªÙ†Ø§</a></li>
              <li><a href="../index.html#contact">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
            </ul>
          </div>

          <div class="footer-contact">
            <h3>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
            <ul>
              <li>
                <svg class="svg-icon" viewBox="0 0 384 512">
                  <use href="../assets/images/icons.svg#icon-map-marker-alt"></use>
                </svg>
                <span>Ù…ØµØ±</span>
              </li>
              <li>
                <svg class="svg-icon" viewBox="0 0 512 512">
                  <use href="../assets/images/icons.svg#icon-phone"></use>
                </svg>
                <span>+20 100 224 1591</span>
              </li>
              <li>
                <svg class="svg-icon" viewBox="0 0 512 512">
                  <use href="../assets/images/icons.svg#icon-envelope"></use>
                </svg>
                <span>salla1zid@gmail.com</span>
              </li>
            </ul>
            <div class="footer-social">
              <a href="https://wa.me/201002241591" target="_blank">
                <svg class="svg-icon" viewBox="0 0 448 512">
                  <use href="../assets/images/icons.svg#icon-whatsapp"></use>
                </svg>
              </a>
              <a href="https://www.instagram.com/salla1zid/" target="_blank">
                <svg class="svg-icon" viewBox="0 0 448 512">
                  <use href="../assets/images/icons.svg#icon-instagram"></use>
                </svg>
              </a>
              <a href="https://twitter.com/salla1zid" target="_blank">
                <svg class="svg-icon" viewBox="0 0 512 512">
                  <use href="../assets/images/icons.svg#icon-twitter"></use>
                </svg>
              </a>
              <a href="https://t.me/cssfree1" target="_blank">
                <svg class="svg-icon" viewBox="0 0 496 512">
                  <use href="../assets/images/icons.svg#icon-telegram"></use>
                </svg>
              </a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>
            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; <span id="currentYear"></span> Ali Ahmed | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ù…ØµØ¯Ø±
          </p>
        </div>
      </div>
    </footer>

    <!-- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø§Ø¦Ù… -->
    <a href="https://wa.me/201002241591" class="floating-whatsapp" target="_blank">
      <svg class="svg-icon" viewBox="0 0 448 512">
        <use href="../assets/images/icons.svg#icon-whatsapp"></use>
      </svg>
    </a>

    <script>
      // App State
      let currentImage = null;
      let canvas = null;
      let ctx = null;
      let cutLines = [];
      let segments = [];
      let lineIdCounter = 0;
      let isDragging = false;
      let draggedLine = null;
      let dragOffsetY = 0;
      let currentImageSignature = null;

      const MAX_SEGMENT_SIZE_BYTES = 1024 * 1024; // 1MB
      const CROP_STORAGE_KEY = 'megasplit.savedCuts.v1';
      const MAX_SAVED_PRESETS = 50;

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        canvas = document.getElementById('imageCanvas');
        ctx = canvas.getContext('2d', { willReadFrequently: true });
        initializeUploadZone();
        document.getElementById('currentYear').textContent = new Date().getFullYear();
      });

      // Upload Zone
      function initializeUploadZone() {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleFile(file);
        });

        uploadZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
          uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.classList.remove('drag-over');
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            handleFile(file);
          } else {
            alert('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­');
          }
        });
      }

      // Handle File Upload
      function handleFile(file) {
        if (file.size > 20 * 1024 * 1024) {
          alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 20MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = async () => {
            currentImage = img;
            currentImageSignature = await createImageSignature(file, img);
            loadImageToCanvas(img);
            restoreSavedCutLines();
            showEditor();
          };
          img.onerror = () => {
            alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      // Load Image to Canvas
      function loadImageToCanvas(img) {
        // Set canvas to match image dimensions
        canvas.width = img.width;
        canvas.height = img.height;

        // Draw image
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        // Setup canvas click for adding cut lines
        canvas.onclick = (e) => {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          const clickY = (e.clientY - rect.top) * scaleY;
          
          addCutLine(clickY);
        };

        // Reset cut lines
        cutLines = [];
        updateCutLinesDisplay();
      }

      // Show Editor
      function showEditor() {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('editorSection').classList.add('active');
        document.getElementById('segmentsSection').classList.remove('active');
      }

      // Add Cut Line
      function addCutLine(y) {
        if (y < 10 || y > canvas.height - 10) {
          return; // Too close to edges
        }

        const lineId = ++lineIdCounter;
        cutLines.push({ id: lineId, y: y });
        cutLines.sort((a, b) => a.y - b.y);
        updateCutLinesDisplay();
        saveCurrentCutLines();
      }

      // Update Cut Lines Display
      function updateCutLinesDisplay() {
        const container = document.getElementById('cutLinesContainer');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const rect = canvas.getBoundingClientRect();
        
        container.innerHTML = '';

        cutLines.forEach((line, index) => {
          const lineEl = document.createElement('div');
          lineEl.className = 'cut-line';
          lineEl.dataset.lineId = line.id;
          
          const scaleY = rect.height / canvas.height;
          const topPos = line.y * scaleY;
          lineEl.style.top = topPos + 'px';

          // Label
          const label = document.createElement('div');
          label.className = 'cut-line-label';
          label.textContent = `Ø®Ø· ${index + 1}`;
          lineEl.appendChild(label);

          // Remove button
          const removeBtn = document.createElement('div');
          removeBtn.className = 'cut-line-remove';
          removeBtn.innerHTML = 'Ã—';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeCutLine(line.id);
          };
          lineEl.appendChild(removeBtn);

          // Drag functionality
          lineEl.onmousedown = (e) => startDrag(e, line.id);

          container.appendChild(lineEl);
        });

        // Position container
        container.style.position = 'absolute';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = rect.width + 'px';
        container.style.height = rect.height + 'px';
        container.style.pointerEvents = 'none';
        
        // Enable pointer events on lines
        container.querySelectorAll('.cut-line').forEach(line => {
          line.style.pointerEvents = 'auto';
        });
      }

      // Drag Functions
      function startDrag(e, lineId) {
        isDragging = true;
        draggedLine = cutLines.find(l => l.id === lineId);
        const lineEl = document.querySelector(`[data-line-id="${lineId}"]`);
        const rect = lineEl.getBoundingClientRect();
        dragOffsetY = e.clientY - rect.top;

        document.onmousemove = onDrag;
        document.onmouseup = stopDrag;
        e.preventDefault();
      }

      function onDrag(e) {
        if (!isDragging || !draggedLine) return;

        const canvasRect = canvas.getBoundingClientRect();
        const scaleY = canvas.height / canvasRect.height;
        const newY = (e.clientY - canvasRect.top - dragOffsetY) * scaleY;

        if (newY >= 10 && newY <= canvas.height - 10) {
          draggedLine.y = newY;
          cutLines.sort((a, b) => a.y - b.y);
          updateCutLinesDisplay();
        }
      }

      function stopDrag() {
        isDragging = false;
        draggedLine = null;
        document.onmousemove = null;
        document.onmouseup = null;
        saveCurrentCutLines();
      }

      // Remove Cut Line
      function removeCutLine(lineId) {
        cutLines = cutLines.filter(l => l.id !== lineId);
        updateCutLinesDisplay();
        saveCurrentCutLines();
      }

      // Clear All Lines
      function clearAllLines() {
        if (cutLines.length === 0) return;
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø®Ø·ÙˆØ· Ø§Ù„Ù‚Ø·Ø¹ØŸ')) {
          cutLines = [];
          updateCutLinesDisplay();
        }
      }

      // Add Equal Segments
      function addEqualSegments() {
        const count = parseInt(document.getElementById('segmentsCount').value);
        if (count < 2 || count > 20) {
          alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø¨ÙŠÙ† 2 Ùˆ 20');
          return;
        }

        cutLines = [];
        const segmentHeight = canvas.height / count;
        
        for (let i = 1; i < count; i++) {
          const y = segmentHeight * i;
          cutLines.push({ id: ++lineIdCounter, y: y });
        }

        updateCutLinesDisplay();
        saveCurrentCutLines();
      }

      // Process Image
      async function processImage() {
        if (cutLines.length === 0) {
          alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ù‚Ø·Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
          return;
        }

        showProgress();
        
        // Small delay to show progress
        await new Promise(resolve => setTimeout(resolve, 500));

        try {
          const format = document.getElementById('outputFormat').value;
          const quality = parseInt(document.getElementById('qualityInput').value) / 100;

          segments = [];

          // Get Y positions and add start/end
          const yPositions = [0, ...cutLines.map(l => l.y), canvas.height];

          // Create segments
          for (let i = 0; i < yPositions.length - 1; i++) {
            const startY = yPositions[i];
            const endY = yPositions[i + 1];
            const height = endY - startY;

            // Create temporary canvas for segment
            const segCanvas = document.createElement('canvas');
            segCanvas.width = canvas.width;
            segCanvas.height = height;
            const segCtx = segCanvas.getContext('2d');

            // Draw segment
            segCtx.drawImage(
              canvas,
              0, startY, canvas.width, height,
              0, 0, canvas.width, height
            );

            // Auto-compress each segment to stay below 1MB.
            const compressedSegment = await compressSegmentToLimit(
              segCanvas,
              format,
              quality,
              MAX_SEGMENT_SIZE_BYTES
            );

            const blob = compressedSegment.blob;
            const extension = getFileExtension(compressedSegment.format);
            const url = URL.createObjectURL(blob);

            segments.push({
              id: i + 1,
              blob: blob,
              url: url,
              width: compressedSegment.width,
              height: compressedSegment.height,
              name: `segment_${i + 1}.${extension}`
            });
          }

          hideProgress();
          showSegments();
        } catch (error) {
          hideProgress();
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
        }
      }

      // Show Segments
      function showSegments() {
        document.getElementById('editorSection').style.display = 'none';
        document.getElementById('segmentsSection').classList.add('active');
        document.getElementById('segmentsTotal').textContent = segments.length;

        const grid = document.getElementById('segmentsGrid');
        grid.innerHTML = '';

        segments.forEach(segment => {
          const card = document.createElement('div');
          card.className = 'segment-card';
          
          card.innerHTML = `
            <img src="${segment.url}" alt="${segment.name}" class="segment-preview" />
            <div class="segment-info">
              <div class="segment-name">
                <i class="fas fa-image"></i>
                ${segment.name}
              </div>
              <div class="segment-meta">
                <span><i class="fas fa-arrows-alt-h"></i> ${segment.width}px</span>
                <span><i class="fas fa-arrows-alt-v"></i> ${segment.height}px</span>
                <span><i class="fas fa-hdd"></i> ${formatBytes(segment.blob.size)}</span>
              </div>
            </div>
            <div class="segment-actions">
              <button class="btn btn-primary btn-sm" onclick="downloadSegment(${segment.id})">
                <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
              </button>
            </div>
          `;

          grid.appendChild(card);
        });
      }

      // Download Segment
      function downloadSegment(id) {
        const segment = segments.find(s => s.id === id);
        if (!segment) return;

        const a = document.createElement('a');
        a.href = segment.url;
        a.download = segment.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // Download All as ZIP
      async function downloadAll() {
        if (!window.JSZip) {
          alert('JSZip library not loaded. Please refresh and try again.');
          return;
        }

        showProgress();

        try {
          const zip = new JSZip();

          segments.forEach(segment => {
            zip.file(segment.name, segment.blob);
          });

          const zipBlob = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(zipBlob);

          const a = document.createElement('a');
          a.href = url;
          a.download = `megasplit_segments_${Date.now()}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          hideProgress();
        } catch (error) {
          hideProgress();
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP: ' + error.message);
        }
      }

      // Reset App
      function resetApp() {
        if (segments.length > 0) {
          segments.forEach(s => URL.revokeObjectURL(s.url));
        }

        currentImage = null;
        currentImageSignature = null;
        cutLines = [];
        segments = [];
        lineIdCounter = 0;

        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('editorSection').classList.remove('active');
        document.getElementById('segmentsSection').classList.remove('active');
        document.getElementById('fileInput').value = '';

        if (ctx) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      // Utility Functions
      async function createImageSignature(file, img) {
        const safeName = (file.name || 'image').trim().toLowerCase();
        return `${safeName}_${img.width}x${img.height}`;
      }

      function getSavedCutPresets() {
        try {
          const raw = localStorage.getItem(CROP_STORAGE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (error) {
          return {};
        }
      }

      function saveCutPresets(presets) {
        try {
          localStorage.setItem(CROP_STORAGE_KEY, JSON.stringify(presets));
        } catch (error) {
          // Ignore storage write errors (quota/privacy mode).
        }
      }

      function saveCurrentCutLines() {
        if (!currentImageSignature || !canvas || canvas.height === 0) return;

        const presets = getSavedCutPresets();
        presets[currentImageSignature] = {
          width: canvas.width,
          height: canvas.height,
          ratios: cutLines
            .map(line => Number((line.y / canvas.height).toFixed(6)))
            .filter(ratio => ratio > 0 && ratio < 1),
          updatedAt: Date.now()
        };

        const trimmedEntries = Object.entries(presets)
          .sort((a, b) => (b[1].updatedAt || 0) - (a[1].updatedAt || 0))
          .slice(0, MAX_SAVED_PRESETS);

        const trimmedPresets = {};
        trimmedEntries.forEach(([key, value]) => {
          trimmedPresets[key] = value;
        });

        saveCutPresets(trimmedPresets);
      }

      function restoreSavedCutLines() {
        if (!currentImageSignature || !canvas || canvas.height === 0) return;

        const presets = getSavedCutPresets();
        const preset = presets[currentImageSignature];
        if (!preset || !Array.isArray(preset.ratios)) return;
        if (preset.width !== canvas.width || preset.height !== canvas.height) return;

        const restoredLines = preset.ratios
          .map(ratio => Number(ratio))
          .filter(ratio => Number.isFinite(ratio) && ratio > 0 && ratio < 1)
          .map(ratio => ({ id: ++lineIdCounter, y: Math.round(ratio * canvas.height) }))
          .filter(line => line.y >= 10 && line.y <= canvas.height - 10);

        cutLines = restoredLines.sort((a, b) => a.y - b.y);
        updateCutLinesDisplay();
      }

      function getCompressionFormatOrder(preferredFormat) {
        if (preferredFormat === 'image/jpeg') return ['image/jpeg', 'image/webp'];
        if (preferredFormat === 'image/webp') return ['image/webp', 'image/jpeg'];
        return ['image/png', 'image/webp', 'image/jpeg'];
      }

      async function compressSegmentToLimit(segmentCanvas, preferredFormat, preferredQuality, maxBytes) {
        const formatOrder = getCompressionFormatOrder(preferredFormat);
        const quality = clamp(preferredQuality, 0.05, 1);

        for (const format of formatOrder) {
          const candidate = await encodeUnderLimit(segmentCanvas, format, quality, maxBytes);
          if (candidate) {
            return {
              ...candidate,
              width: segmentCanvas.width,
              height: segmentCanvas.height
            };
          }
        }

        throw new Error('ØªØ¹Ø°Ø± Ø¶ØºØ· Ø¬Ø²Ø¡ Ù„Ø£Ù‚Ù„ Ù…Ù† 1MB. Ø­Ø§ÙˆÙ„ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡.');
      }

      async function encodeUnderLimit(sourceCanvas, format, preferredQuality, maxBytes) {
        if (format === 'image/png') {
          const pngBlob = await canvasToBlobSafe(sourceCanvas, format);
          if (pngBlob.size <= maxBytes) {
            return { blob: pngBlob, format: format };
          }
          return null;
        }

        let low = 0.05;
        let high = clamp(preferredQuality, 0.05, 1);
        let bestBlob = null;

        const firstBlob = await canvasToBlobSafe(sourceCanvas, format, high);
        if (firstBlob.size <= maxBytes) {
          bestBlob = firstBlob;
          low = high;
        } else {
          for (let i = 0; i < 8; i++) {
            const mid = (low + high) / 2;
            const midBlob = await canvasToBlobSafe(sourceCanvas, format, mid);

            if (midBlob.size <= maxBytes) {
              bestBlob = midBlob;
              low = mid;
            } else {
              high = mid;
            }
          }
        }

        if (bestBlob && bestBlob.size <= maxBytes) {
          return { blob: bestBlob, format: format };
        }

        const minBlob = await canvasToBlobSafe(sourceCanvas, format, 0.05);
        if (minBlob.size <= maxBytes) {
          return { blob: minBlob, format: format };
        }

        return null;
      }

      function canvasToBlobSafe(sourceCanvas, format, quality) {
        return new Promise((resolve, reject) => {
          let exportCanvas = sourceCanvas;

          if (format === 'image/jpeg') {
            exportCanvas = document.createElement('canvas');
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;

            const exportCtx = exportCanvas.getContext('2d');
            exportCtx.fillStyle = '#FFFFFF';
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            exportCtx.drawImage(sourceCanvas, 0, 0);
          }

          exportCanvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error('Image encoding failed.'));
                return;
              }
              resolve(blob);
            },
            format,
            format === 'image/png' ? undefined : quality
          );
        });
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function getFileExtension(format) {
        const map = {
          'image/png': 'png',
          'image/jpeg': 'jpg',
          'image/webp': 'webp'
        };
        return map[format] || 'png';
      }

      function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }

      function showProgress() {
        document.getElementById('progressOverlay').classList.add('active');
      }

      function hideProgress() {
        document.getElementById('progressOverlay').classList.remove('active');
      }

      // Handle window resize
      window.addEventListener('resize', () => {
        if (cutLines.length > 0) {
          updateCutLinesDisplay();
        }
      });
    </script>
  </body>
</html>
